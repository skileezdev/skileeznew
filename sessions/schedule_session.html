{% extends "base.html" %}

{% block title %}Schedule Session - Skileez{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-calendar-plus me-2"></i>Schedule Session
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Contract Summary -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading">Contract Summary</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Contract:</strong> {{ contract.title }}<br>
                                <strong>Coach:</strong> {{ contract.coach.first_name }} {{ contract.coach.last_name }}<br>
                                <strong>Student:</strong> {{ contract.student.first_name }} {{ contract.student.last_name }}
                            </div>
                            <div class="col-md-6">
                                <strong>Total Sessions:</strong> {{ contract.number_of_sessions }}<br>
                                <strong>Session Duration:</strong> {{ contract.session_duration }} minutes<br>
                                <strong>Price per Hour:</strong> ${{ "%.2f"|format(contract.price_per_hour) }}
                            </div>
                        </div>
                    </div>

                    <!-- Session Progress -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Session Progress</h6>
                        </div>
                        <div class="card-body">
                            {% set completed_sessions = contract.sessions|selectattr('status', 'equalto', 'completed')|list|length %}
                            {% set scheduled_sessions = contract.sessions|selectattr('status', 'equalto', 'scheduled')|list|length %}
                            {% set total_sessions = contract.sessions|length %}
                            
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h4 text-success mb-1">{{ completed_sessions }}</div>
                                    <small class="text-muted">Completed</small>
                                </div>
                                <div class="col-4">
                                    <div class="h4 text-primary mb-1">{{ scheduled_sessions }}</div>
                                    <small class="text-muted">Scheduled</small>
                                </div>
                                <div class="col-4">
                                    <div class="h4 text-warning mb-1">{{ contract.number_of_sessions - total_sessions }}</div>
                                    <small class="text-muted">Remaining</small>
                                </div>
                            </div>
                            
                            <div class="progress mt-3">
                                {% set progress = (total_sessions / contract.number_of_sessions) * 100 %}
                                <div class="progress-bar bg-success" style="width: {{ (completed_sessions / contract.number_of_sessions) * 100 }}%"></div>
                                <div class="progress-bar bg-primary" style="width: {{ (scheduled_sessions / contract.number_of_sessions) * 100 }}%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Form -->
                    <form method="POST" class="needs-validation" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.session_date.id }}" class="form-label">
                                        <strong>{{ form.session_date.label }}</strong>
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.session_date(class="form-control", type="date") }}
                                    {% if form.session_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.session_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Select a date for the session</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.session_time.id }}" class="form-label">
                                        <strong>{{ form.session_time.label }}</strong>
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.session_time(class="form-control", type="time") }}
                                    {% if form.session_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.session_time.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Select a time for the session</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.duration.id }}" class="form-label">
                                <strong>{{ form.duration.label }}</strong>
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.duration(class="form-select") }}
                            {% if form.duration.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.duration.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Session duration (default: {{ contract.session_duration }} minutes)</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id }}" class="form-label">
                                <strong>{{ form.notes.label }}</strong>
                            </label>
                            {{ form.notes(class="form-control", rows="3", placeholder="Any notes about this session...") }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-calendar-check me-2"></i>Schedule Session
                            </button>
                            <a href="{{ url_for('conversation', user_id=contract.coach_id if current_user.id == contract.student_id else contract.student_id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Conversation
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Existing Sessions -->
            {% if contract.sessions %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Scheduled Sessions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Session #</th>
                                    <th>Date & Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in contract.sessions|sort(attribute='session_number') %}
                                <tr>
                                    <td>{{ session.session_number }}</td>
                                    <td>
                                        {{ session.scheduled_date.strftime('%B %d, %Y at %I:%M %p') }}
                                        {% if session.status == 'reschedule_requested' %}
                                        <br><small class="text-warning">
                                            <i class="fas fa-clock me-1"></i>Reschedule requested
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td>{{ session.duration }} minutes</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if session.status == 'completed' else 'primary' if session.status == 'scheduled' else 'warning' if session.status == 'reschedule_requested' else 'secondary' }}">
                                            {{ session.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if session.status == 'scheduled' %}
                                        <button class="btn btn-sm btn-outline-warning" onclick="requestReschedule({{ session.id }})">
                                            <i class="fas fa-clock me-1"></i>Reschedule
                                        </button>
                                        {% elif session.status == 'reschedule_requested' and session.reschedule_requested_by != current_user.current_role %}
                                        <button class="btn btn-sm btn-success" onclick="approveReschedule({{ session.id }})">
                                            <i class="fas fa-check me-1"></i>Approve
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Reschedule Modal -->
<div class="modal fade" id="rescheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Reschedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rescheduleForm">
                    <div class="mb-3">
                        <label for="newDate" class="form-label">New Date</label>
                        <input type="date" class="form-control" id="newDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="newTime" class="form-label">New Time</label>
                        <input type="time" class="form-control" id="newTime" required>
                    </div>
                    <div class="mb-3">
                        <label for="rescheduleReason" class="form-label">Reason for Reschedule</label>
                        <textarea class="form-control" id="rescheduleReason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="submitReschedule">Request Reschedule</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentSessionId = null;
const rescheduleModal = new bootstrap.Modal(document.getElementById('rescheduleModal'));

function requestReschedule(sessionId) {
    currentSessionId = sessionId;
    rescheduleModal.show();
}

function approveReschedule(sessionId) {
    if (confirm('Are you sure you want to approve this reschedule request?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/session/${sessionId}/approve-reschedule`;
        document.body.appendChild(form);
        form.submit();
    }
}

document.getElementById('submitReschedule')?.addEventListener('click', function() {
    const form = document.getElementById('rescheduleForm');
    if (form.checkValidity()) {
        const formData = new FormData();
        formData.append('new_date', document.getElementById('newDate').value);
        formData.append('new_time', document.getElementById('newTime').value);
        formData.append('reason', document.getElementById('rescheduleReason').value);
        
        fetch(`/session/${currentSessionId}/reschedule`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                rescheduleModal.hide();
                location.reload();
            } else {
                alert('Error requesting reschedule');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while requesting reschedule');
        });
    } else {
        form.reportValidity();
    }
});

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    }
    
    // Set minimum date to today
    const dateInput = document.getElementById('{{ form.session_date.id }}');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
    }
});
</script>
{% endblock %}
