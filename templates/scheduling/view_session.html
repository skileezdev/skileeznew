{% extends "base.html" %}

{% block title %}Session Details{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Session Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        {% if scheduled_session.is_consultation %}
                            Free Consultation
                        {% else %}
                            Coaching Session
                        {% endif %}
                    </h1>
                    <p class="text-gray-600 mt-1">
                        {% if current_user.id == scheduled_session.coach_id %}
                            with {{ scheduled_session.student.first_name }} {{ scheduled_session.student.last_name }}
                        {% else %}
                            with {{ scheduled_session.coach.first_name }} {{ scheduled_session.coach.last_name }}
                        {% endif %}
                    </p>
                </div>
                <div class="text-right">
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                        {% if scheduled_session.status == 'scheduled' %}bg-blue-100 text-blue-800
                        {% elif scheduled_session.status == 'confirmed' %}bg-green-100 text-green-800
                        {% elif scheduled_session.status == 'started' %}bg-yellow-100 text-yellow-800
                        {% elif scheduled_session.status == 'completed' %}bg-gray-100 text-gray-800
                        {% elif scheduled_session.status == 'cancelled' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ scheduled_session.status.title() }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Details -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Session Information -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Session Information</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Date & Time</label>
                            <p class="text-sm text-gray-900 mt-1">
                                {{ scheduled_session.scheduled_at.strftime('%A, %B %d, %Y at %I:%M %p') }}
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Duration</label>
                            <p class="text-sm text-gray-900 mt-1">{{ scheduled_session.duration_minutes }} minutes</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Timezone</label>
                            <p class="text-sm text-gray-900 mt-1">{{ scheduled_session.timezone }}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Session Type</label>
                            <p class="text-sm text-gray-900 mt-1">
                                {% if scheduled_session.is_consultation %}
                                    <span class="text-green-600">Free Consultation</span>
                                {% else %}
                                    <span class="text-primary-600">Paid Session</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Google Meet Section -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">üìπ Google Meet</h2>
                    {% if scheduled_session.google_meet_url %}
                        <div class="alert alert-success">
                            <p><strong>Meeting Ready!</strong></p>
                            <a href="{{ scheduled_session.google_meet_url }}" target="_blank" class="btn btn-success">
                                üé• Join Meeting
                            </a>
                            <a href="{{ url_for('meeting_dashboard', session_id=scheduled_session.id) }}" class="btn btn-info ml-2">
                                üìä Meeting Dashboard
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <p>Meeting not created yet.</p>
                            {% if current_user.is_coach and current_user.id == scheduled_session.coach_id %}
                                <a href="{{ url_for('meeting_setup', session_id=scheduled_session.id) }}" class="btn btn-primary">
                                    ‚öôÔ∏è Setup Meeting
                                </a>
                            {% else %}
                                <p class="text-muted mt-2">Waiting for coach to setup the meeting...</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

                <!-- Reschedule Request -->
                {% if scheduled_session.reschedule_requested %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">
                                Reschedule Requested
                            </h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p><strong>Requested by:</strong> {{ scheduled_session.reschedule_requested_by.title() }}</p>
                                <p><strong>Reason:</strong> {{ scheduled_session.reschedule_reason }}</p>
                                <p><strong>Deadline:</strong> {{ scheduled_session.reschedule_deadline.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            </div>
                            
                            {% if current_user.id != scheduled_session.reschedule_requested_by_id %}
                            <div class="mt-4 flex space-x-3">
                                <button onclick="approveReschedule()" 
                                        class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700">
                                    Approve
                                </button>
                                <button onclick="declineReschedule()" 
                                        class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700">
                                    Decline
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Google Meet Session -->
                {% if scheduled_session.status in ['scheduled', 'confirmed', 'started'] %}
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Google Meet Session</h2>
                    
                    {% if scheduled_session.google_meet_url %}
                        <div class="mb-4">
                            <div class="bg-green-50 border border-green-200 rounded-md p-4">
                                <div class="flex items-center">
                                    <svg class="h-5 w-5 text-green-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="text-sm font-medium text-green-800">Meeting Ready</span>
                                </div>
                                <p class="text-sm text-green-700 mt-1">Google Meet meeting is set up and ready to use.</p>
                                <div class="mt-3">
                                    <a href="{{ scheduled_session.google_meet_url }}" target="_blank" 
                                       class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                        <svg class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 011.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                        </svg>
                                        Join Google Meet
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="mb-4">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                <div class="flex items-center">
                                    <svg class="h-5 w-5 text-yellow-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="text-sm font-medium text-yellow-800">Meeting Setup Required</span>
                                </div>
                                <p class="text-sm text-yellow-700 mt-1">Google Meet meeting needs to be set up for this session.</p>
                                {% if current_user.is_coach and current_user.id == scheduled_session.coach_id %}
                                <div class="mt-3">
                                    <a href="{{ url_for('meeting_setup', session_id=scheduled_session.id) }}" 
                                       class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">
                                        <svg class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 011.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                        </svg>
                                        Setup Google Meet
                                    </a>
                                </div>
                                {% else %}
                                <p class="text-sm text-yellow-600 mt-2">Waiting for coach to setup the meeting...</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if scheduled_session.status == 'scheduled' and current_user.id == scheduled_session.coach_id %}
                        <button onclick="startGoogleMeetSession()" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                            Start Session
                        </button>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Session Actions -->
                {% if scheduled_session.status in ['scheduled', 'confirmed'] %}
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Actions</h2>
                    
                    <div class="flex flex-wrap gap-3">
                        {% if scheduled_session.can_be_rescheduled(current_user.current_role) %}
                        <a href="{{ url_for('reschedule_session', session_id=scheduled_session.id) }}" 
                           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Request Reschedule
                        </a>
                        {% endif %}
                        
                        {% if scheduled_session.can_be_cancelled(current_user.current_role) %}
                        <button onclick="cancelSession()" 
                                class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                            Cancel Session
                        </button>
                        {% endif %}
                        
                        {% if scheduled_session.status == 'started' %}
                        <button onclick="completeSession()" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                            Complete Session
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                    
                    <div class="space-y-3">
                        <a href="{{ url_for('scheduling_dashboard') }}" 
                           class="block w-full text-left px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md">
                            ‚Üê Back to Dashboard
                        </a>
                        
                        {% if current_user.id == scheduled_session.coach_id %}
                        <a href="{{ url_for('coach_scheduling_settings') }}" 
                           class="block w-full text-left px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md">
                            ‚öôÔ∏è Scheduling Settings
                        </a>
                        {% endif %}
                        
                        <a href="#" onclick="addToCalendar()" 
                           class="block w-full text-left px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md">
                            üìÖ Add to Calendar
                        </a>
                    </div>
                </div>

                <!-- Session Notes -->
                {% if scheduled_session.session and (scheduled_session.session.student_notes or scheduled_session.session.coach_notes) %}
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Session Notes</h3>
                    
                    {% if scheduled_session.session.student_notes %}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-500">Student Notes</label>
                        <p class="text-sm text-gray-900 mt-1">{{ scheduled_session.session.student_notes }}</p>
                    </div>
                    {% endif %}
                    
                    {% if scheduled_session.session.coach_notes %}
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Coach Notes</label>
                        <p class="text-sm text-gray-900 mt-1">{{ scheduled_session.session.coach_notes }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Time Until Session -->
                {% if scheduled_session.status in ['scheduled', 'confirmed'] %}
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Time Until Session</h3>
                    
                    <div id="countdown" class="text-2xl font-bold text-primary-600">
                        Loading...
                    </div>
                    
                    <p class="text-sm text-gray-500 mt-2">
                        Session starts in {{ scheduled_session.scheduled_at.strftime('%B %d, %Y at %I:%M %p') }}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Cancel Session Modal -->
<div id="cancel-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cancel Session</h3>
            <p class="text-sm text-gray-500 mb-6">
                Are you sure you want to cancel this session? This action cannot be undone.
            </p>
            <div class="flex justify-center space-x-3">
                <button onclick="closeCancelModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Keep Session
                </button>
                <button onclick="confirmCancelSession()" 
                        class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700">
                    Cancel Session
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Countdown timer
function updateCountdown() {
    const sessionTime = new Date('{{ scheduled_session.scheduled_at.isoformat() }}');
    const now = new Date();
    const diff = sessionTime - now;
    
    if (diff <= 0) {
        document.getElementById('countdown').textContent = 'Session time has passed';
        return;
    }
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    let countdownText = '';
    if (days > 0) countdownText += `${days}d `;
    if (hours > 0) countdownText += `${hours}h `;
    if (minutes > 0) countdownText += `${minutes}m `;
    countdownText += `${seconds}s`;
    
    document.getElementById('countdown').textContent = countdownText;
}

// Update countdown every second
setInterval(updateCountdown, 1000);
updateCountdown();

// Session actions
function startGoogleMeetSession() {
    fetch(`/scheduling/session/{{ scheduled_session.id }}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error starting session: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while starting the session');
    });
}

function cancelSession() {
    document.getElementById('cancel-modal').classList.remove('hidden');
}

function closeCancelModal() {
    document.getElementById('cancel-modal').classList.add('hidden');
}

function confirmCancelSession() {
    fetch(`/scheduling/session/{{ scheduled_session.id }}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '{{ url_for("scheduling_dashboard") }}';
        } else {
            alert('Error cancelling session');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while cancelling the session');
    });
}

function completeSession() {
    const notes = prompt('Enter session notes (optional):');
    
    fetch(`/scheduling/session/{{ scheduled_session.id }}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ notes: notes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error completing session: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while completing the session');
    });
}

function approveReschedule() {
    const newTime = prompt('Enter new scheduled time (YYYY-MM-DD HH:MM):');
    if (!newTime) return;
    
    fetch(`/scheduling/session/{{ scheduled_session.id }}/approve-reschedule`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ new_scheduled_at: newTime })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.message || 'Reschedule approved successfully!');
            window.location.reload();
        } else {
            alert('Error approving reschedule: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while approving the reschedule: ' + error.message);
    });
}

function declineReschedule() {
    if (!confirm('Are you sure you want to decline this reschedule request?')) return;
    
    fetch(`/scheduling/session/{{ scheduled_session.id }}/decline-reschedule`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.message || 'Reschedule declined successfully!');
            window.location.reload();
        } else {
            alert('Error declining reschedule: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while declining the reschedule: ' + error.message);
    });
}

function addToCalendar() {
    const session = {
        title: '{% if scheduled_session.is_consultation %}Free Consultation{% else %}Coaching Session{% endif %} with {{ scheduled_session.coach.first_name }} {{ scheduled_session.coach.last_name }}',
        start: '{{ scheduled_session.scheduled_at.isoformat() }}',
        end: '{{ (scheduled_session.scheduled_at + timedelta(minutes=scheduled_session.duration_minutes)).isoformat() }}',
        description: '{% if scheduled_session.is_consultation %}Free consultation session{% else %}Paid coaching session{% endif %}'
    };
    
    // Create calendar event URL
    const eventUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(session.title)}&dates=${session.start.replace(/[-:]/g, '')}/${session.end.replace(/[-:]/g, '')}&details=${encodeURIComponent(session.description)}`;
    
    window.open(eventUrl, '_blank');
}
</script>
{% endblock %}
