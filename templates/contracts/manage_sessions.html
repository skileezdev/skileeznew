{% extends "base.html" %}

{% block title %}Manage Sessions - Contract {{ contract.contract_number }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Manage Sessions</h1>
                    <p class="text-gray-600">Contract {{ contract.contract_number }}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <a href="{{ url_for('view_contract', contract_id=contract.id) }}" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>
                        Back to Contract
                    </a>
                    <a href="{{ url_for('conversation', user_id=contract.coach_id if user.current_role == 'student' else contract.student_id) }}" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <i data-feather="message-circle" class="w-4 h-4 mr-2"></i>
                        Message
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sessions List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Sessions</h2>
                        <p class="text-sm text-gray-600">{{ sessions|length }} of {{ contract.total_sessions }} sessions</p>
                    </div>
                    <div class="px-6 py-4">
                        {% if sessions %}
                        <div class="space-y-4">
                            {% for session in sessions %}
                            <div class="border rounded-lg p-4 {% if session.status == 'completed' %}bg-green-50 border-green-200{% elif session.status == 'cancelled' %}bg-red-50 border-red-200{% elif session.status == 'missed' %}bg-yellow-50 border-yellow-200{% else %}bg-blue-50 border-blue-200{% endif %}">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="font-medium text-gray-900">Session {{ session.session_number }}</h3>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                {% if session.status == 'completed' %}bg-green-100 text-green-800
                                                {% elif session.status == 'cancelled' %}bg-red-100 text-red-800
                                                {% elif session.status == 'missed' %}bg-yellow-100 text-yellow-800
                                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                                {{ session.status|title }}
                                            </span>
                                        </div>
                                        
                                        {% if session.scheduled_at %}
                                        <p class="text-sm text-gray-600 mt-1">
                                            {{ session.scheduled_at|format_datetime }} ({{ session.duration_minutes }} minutes)
                                            {% if session.timezone %}
                                            <br><span class="text-xs text-gray-500">Timezone: {{ session.timezone }}</span>
                                            {% endif %}
                                        </p>
                                        {% else %}
                                        <p class="text-sm text-gray-500 mt-1">Not scheduled yet</p>
                                        {% endif %}
                                        
                                        {% if session.reschedule_requested %}
                                        <div class="mt-2 p-2 bg-orange-50 border border-orange-200 rounded">
                                            <p class="text-sm text-orange-800">
                                                <strong>Reschedule Requested:</strong> {{ session.reschedule_reason }}
                                            </p>
                                            <p class="text-xs text-orange-600 mt-1">
                                                Requested by: {{ session.reschedule_requested_by|title }}
                                                {% if session.reschedule_proposed_time is defined and session.reschedule_proposed_time %}
                                                <br>Proposed time: {{ session.reschedule_proposed_time.strftime('%Y-%m-%d %H:%M') }}
                                                {% endif %}
                                            </p>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Reschedule Status Indicators -->
                                        {% if session.reschedule_status is defined and session.reschedule_status %}
                                        <div class="mt-2 p-2 {% if session.reschedule_status == 'approved' %}bg-green-50 border-green-200{% elif session.reschedule_status == 'declined' %}bg-red-50 border-red-200{% else %}bg-gray-50 border-gray-200{% endif %} border rounded">
                                            <div class="flex items-center">
                                                {% if session.reschedule_status == 'approved' %}
                                                <i data-feather="check-circle" class="w-4 h-4 text-green-600 mr-2"></i>
                                                <p class="text-sm text-green-800">
                                                    <strong>Reschedule Approved:</strong> Your reschedule request has been approved
                                                </p>
                                                {% elif session.reschedule_status == 'declined' %}
                                                <i data-feather="x-circle" class="w-4 h-4 text-red-600 mr-2"></i>
                                                <p class="text-sm text-red-800">
                                                    <strong>Reschedule Declined:</strong> Your reschedule request has been declined. Session remains at original time.
                                                </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% elif not session.reschedule_requested and session.reschedule_requested_by %}
                                        <!-- Show approval status using existing fields -->
                                        <div class="mt-2 p-2 bg-green-50 border-green-200 border rounded">
                                            <div class="flex items-center">
                                                <i data-feather="check-circle" class="w-4 h-4 text-green-600 mr-2"></i>
                                                <p class="text-sm text-green-800">
                                                    <strong>Reschedule Approved:</strong> Your reschedule request has been approved
                                                </p>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="flex items-center space-x-2">
                                        {% if session.status == 'scheduled' %}
                                            <!-- Coach Confirmation -->
                                            {% if user.current_role == 'coach' and not session.confirmed_by_coach %}
                                            <form method="POST" action="{{ url_for('confirm_session', session_id=session.id) }}" class="inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="text-sm text-blue-600 hover:text-blue-800">
                                                    Confirm
                                                </button>
                                            </form>
                                            {% endif %}
                                            
                                            <!-- Reschedule Request -->
                                            {% if session.can_request_reschedule(user.current_role) %}
                                            <a href="{{ url_for('request_reschedule', session_id=session.id) }}" 
                                               class="text-sm text-orange-600 hover:text-orange-800">
                                                Reschedule
                                            </a>
                                            {% endif %}
                                            
                                            <!-- Reschedule Approval/Decline (Coach Only) -->
                                            {% if session.reschedule_requested and session.reschedule_requested_by == 'student' and user.current_role == 'coach' %}
                                            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                                                <p class="text-sm text-blue-800 mb-2">
                                                    <strong>Coach Action Required:</strong> Student has requested a reschedule
                                                </p>
                                                {% if session.reschedule_proposed_time is defined and session.reschedule_proposed_time %}
                                                <p class="text-sm text-blue-700 mb-2">
                                                    <strong>Student's Proposed Time:</strong> {{ session.reschedule_proposed_time.strftime('%Y-%m-%d %H:%M') }}
                                                </p>
                                                {% endif %}
                                                
                                                <div class="flex items-center space-x-2 mt-2">
                                                    <form method="POST" action="{{ url_for('approve_reschedule', session_id=session.id) }}" class="inline">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                        <button type="submit" 
                                                                class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                                                            Approve Reschedule
                                                        </button>
                                                    </form>
                                                    <form method="POST" action="{{ url_for('decline_reschedule', session_id=session.id) }}" class="inline">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                        <button type="submit" 
                                                                class="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700"
                                                                onclick="return confirm('Are you sure you want to decline this reschedule request?')">
                                                            Decline
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Session Completion -->
                                            {% if session.can_be_completed() %}
                                            <a href="{{ url_for('session_completion_form', session_id=session.id) }}" 
                                               class="text-sm text-green-600 hover:text-green-800">
                                                Complete
                                            </a>
                                            {% endif %}
                                            
                                            <!-- Session Cancellation -->
                                            <form method="POST" action="{{ url_for('cancel_session', session_id=session.id) }}" class="inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="text-sm text-red-600 hover:text-red-800"
                                                        onclick="return confirm('Are you sure you want to cancel this session?')">
                                                    Cancel
                                                </button>
                                            </form>
                                            
                                        {% elif session.status == 'completed' %}
                                            <!-- View completion details -->
                                            <span class="text-sm text-green-600">
                                                <i data-feather="check-circle" class="w-4 h-4 inline mr-1"></i>
                                                Completed
                                            </span>
                                            
                                        {% elif session.status == 'cancelled' %}
                                            <!-- View cancellation details -->
                                            <span class="text-sm text-red-600">
                                                <i data-feather="x-circle" class="w-4 h-4 inline mr-1"></i>
                                                Cancelled
                                            </span>
                                            
                                        {% elif session.status == 'missed' %}
                                            <!-- View missed details -->
                                            <span class="text-sm text-yellow-600">
                                                <i data-feather="clock" class="w-4 h-4 inline mr-1"></i>
                                                Missed
                                            </span>
                                        {% endif %}
                                        
                                        <!-- Session Actions Dropdown for Mobile -->
                                        <div class="relative md:hidden">
                                            <button class="text-gray-400 hover:text-gray-600">
                                                <i data-feather="more-vertical" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-8">
                            <i data-feather="calendar" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-500">No sessions scheduled yet.</p>
                            <p class="text-sm text-gray-400 mt-1">Schedule your first session below.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Schedule New Session -->
            <div class="lg:col-span-1">
                {% if active_sessions|length < contract.total_sessions %}
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Schedule New Session</h2>
                        <p class="text-sm text-gray-600">Session {{ active_sessions|length + 1 }} of {{ contract.total_sessions }}</p>
                    </div>
                    <div class="px-6 py-4">
                        <form method="POST" class="space-y-4">
                            {{ form.hidden_tag() }}
                            
                            <div>
                                {{ form.scheduled_at.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                                {{ form.scheduled_at(class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500", type="datetime-local") }}
                                {% if form.scheduled_at.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.scheduled_at.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <div>
                                {{ form.duration_minutes.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                                {{ form.duration_minutes(class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500", placeholder="60") }}
                                {% if form.duration_minutes.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.duration_minutes.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <div>
                                {{ form.timezone.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                                
                                <!-- Auto-detection message -->
                                <div id="timezone-detection-message" class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                                    <div class="flex items-center">
                                        <i data-feather="map-pin" class="w-4 h-4 text-blue-600 mr-2"></i>
                                        <span class="text-sm text-blue-800">
                                            <span id="detected-timezone-text">We detected your timezone as</span>
                                            <strong id="detected-timezone-name" class="ml-1"></strong>
                                        </span>
                                    </div>
                                    <p class="text-xs text-blue-600 mt-1">You can change it below if needed.</p>
                                </div>
                                
                                {{ form.timezone(class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 timezone-select-enhanced", id="timezone-select", style="background: white !important; color: #374151 !important; border: 2px solid #e5e7eb !important;") }}
                                <p id="timezone-info" class="mt-1 text-sm text-gray-500"></p>
                                {% if form.timezone.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.timezone.errors[0] }}</p>
                                {% endif %}
                                
                                <!-- Manual override button -->
                                <div class="mt-2">
                                    <button type="button" id="manual-timezone-btn" class="text-sm text-primary-600 hover:text-primary-800 hidden">
                                        <i data-feather="edit-2" class="w-3 h-3 inline mr-1"></i>
                                        Choose different timezone
                                    </button>
                                </div>
                            </div>

                            <button type="submit" 
                                    class="w-full px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                Schedule Session {{ active_sessions|length + 1 }}
                            </button>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">All Sessions Scheduled</h2>
                    </div>
                    <div class="px-6 py-4 text-center">
                        <i data-feather="check-circle" class="w-12 h-12 text-green-500 mx-auto mb-4"></i>
                        <p class="text-gray-600">All {{ contract.total_sessions }} sessions have been scheduled.</p>
                    </div>
                </div>
                {% endif %}

                <!-- Contract Summary -->
                <div class="mt-6 bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Contract Summary</h2>
                    </div>
                    <div class="px-6 py-4">
                        <dl class="space-y-3">
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-500">Total Sessions:</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ contract.total_sessions }}</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-500">Completed:</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ contract.completed_sessions }}</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-500">Remaining:</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ contract.total_sessions - contract.completed_sessions }}</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-500">Rate per Session:</dt>
                                <dd class="text-sm font-medium text-gray-900">${{ "%.2f"|format(contract.rate) }}</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-500">Total Value:</dt>
                                <dd class="text-sm font-medium text-gray-900">${{ "%.2f"|format(contract.total_amount) }}</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-500">Paid Amount:</dt>
                                <dd class="text-sm font-medium text-gray-900">${{ "%.2f"|format(contract.paid_amount) }}</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Timezone Selector Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/timezone-selector.css') }}">

<!-- Timezone Detection Script -->
<script src="{{ url_for('static', filename='js/timezone-detection.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set minimum date/time to now
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('{{ form.scheduled_at.id }}').min = localDateTime;
        
        // Set default duration to contract duration
        document.getElementById('{{ form.duration_minutes.id }}').value = {{ contract.duration_minutes or 60 }};
        
        // Initialize timezone detection with contract timezone as fallback
        const timezoneDetector = new TimezoneDetector({
            selectId: 'timezone-select',
            messageId: 'timezone-detection-message',
            detectedNameId: 'detected-timezone-name',
            manualBtnId: 'manual-timezone-btn',
            showCurrentTime: true,
            autoHide: true
        });

        // Set contract timezone as fallback if no detection occurs
        setTimeout(() => {
            const timezoneSelect = document.getElementById('timezone-select');
            if (timezoneSelect && !timezoneSelect.value) {
                timezoneSelect.value = '{{ contract.timezone }}';
            }
        }, 100);

        // Listen for timezone detection events
        document.addEventListener('timezoneDetector:timezoneDetected', function(e) {
            console.log('Timezone detected for session scheduling:', e.detail);
        });

        document.addEventListener('timezoneDetector:manualOverride', function(e) {
            console.log('User chose manual timezone selection for session scheduling');
        });
    });

    // Function to approve reschedule without changing time
    function approveWithoutTimeChange(sessionId) {
        if (confirm('Are you sure you want to approve this reschedule request without changing the scheduled time?')) {
            // Create a form to submit the approval without new time
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/sessions/${sessionId}/approve-reschedule`;
            
            // Add CSRF token
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add to page and submit
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}
