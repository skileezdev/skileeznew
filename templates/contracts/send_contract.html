{% extends "base.html" %}

{% block title %}Send Contract - Skileez{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-file-contract me-2"></i>Send Contract Offer
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Application Summary -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading">Application Summary</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Coach:</strong> {{ application.coach.first_name }} {{ application.coach.last_name }}<br>
                                <strong>Job:</strong> {{ application.job_post.title }}<br>
                                <strong>Proposed Price:</strong> ${{ "%.2f"|format(application.proposed_price_per_hour) }}/hr
                            </div>
                            <div class="col-md-6">
                                <strong>Proposed Sessions:</strong> {{ application.proposed_number_of_sessions }}<br>
                                <strong>Session Duration:</strong> {{ application.proposed_session_duration }} minutes<br>
                                <strong>Total Proposed:</strong> ${{ "%.2f"|format(application.total_proposed_price) }}
                            </div>
                        </div>
                    </div>

                    <form method="POST" class="needs-validation" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <!-- Contract Title -->
                        <div class="mb-3">
                            <label for="{{ form.title.id }}" class="form-label">
                                <strong>{{ form.title.label }}</strong>
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.title(class="form-control", placeholder="e.g., Python Data Science Tutoring Contract") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Contract Terms -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Contract Terms</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.start_date.id }}" class="form-label">
                                                <strong>{{ form.start_date.label }}</strong>
                                                <span class="text-danger">*</span>
                                            </label>
                                            {{ form.start_date(class="form-control", type="date") }}
                                            {% if form.start_date.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.start_date.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.number_of_sessions.id }}" class="form-label">
                                                <strong>{{ form.number_of_sessions.label }}</strong>
                                                <span class="text-danger">*</span>
                                            </label>
                                            {{ form.number_of_sessions(class="form-control") }}
                                            {% if form.number_of_sessions.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.number_of_sessions.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.session_duration.id }}" class="form-label">
                                                <strong>{{ form.session_duration.label }}</strong>
                                                <span class="text-danger">*</span>
                                            </label>
                                            {{ form.session_duration(class="form-select") }}
                                            {% if form.session_duration.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.session_duration.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.price_per_hour.id }}" class="form-label">
                                                <strong>{{ form.price_per_hour.label }}</strong>
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                {{ form.price_per_hour(class="form-control") }}
                                            </div>
                                            {% if form.price_per_hour.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.price_per_hour.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.timeframe.id }}" class="form-label">
                                        <strong>{{ form.timeframe.label }}</strong>
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.timeframe(class="form-control", placeholder="e.g., 2 weeks, 1 month") }}
                                    {% if form.timeframe.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.timeframe.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.preferred_learning_times.id }}" class="form-label">
                                        <strong>{{ form.preferred_learning_times.label }}</strong>
                                    </label>
                                    {{ form.preferred_learning_times(class="form-control", placeholder="e.g., Weekdays 6-8 PM, Weekends 10 AM-2 PM") }}
                                    {% if form.preferred_learning_times.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.preferred_learning_times.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Learning Outcomes -->
                        <div class="mb-3">
                            <label for="{{ form.expected_learning_outcomes.id }}" class="form-label">
                                <strong>{{ form.expected_learning_outcomes.label }}</strong>
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.expected_learning_outcomes(class="form-control", rows="4", placeholder="Describe what the student expects to learn and accomplish...") }}
                            {% if form.expected_learning_outcomes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.expected_learning_outcomes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Be specific about learning goals and expected outcomes</div>
                        </div>

                        <!-- Cancellation Policy -->
                        <div class="mb-3">
                            <label for="{{ form.cancellation_policy.id }}" class="form-label">
                                <strong>{{ form.cancellation_policy.label }}</strong>
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.cancellation_policy(class="form-control", rows="3", placeholder="e.g., Free cancellation up to 24 hours before session. Late cancellations may incur charges.") }}
                            {% if form.cancellation_policy.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cancellation_policy.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Additional Notes -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.student_notes.id }}" class="form-label">
                                        <strong>{{ form.student_notes.label }}</strong>
                                    </label>
                                    {{ form.student_notes(class="form-control", rows="3", placeholder="Any additional notes for the coach...") }}
                                    {% if form.student_notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.student_notes.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.coach_notes.id }}" class="form-label">
                                        <strong>{{ form.coach_notes.label }}</strong>
                                    </label>
                                    {{ form.coach_notes(class="form-control", rows="3", placeholder="Any notes for the coach...") }}
                                    {% if form.coach_notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.coach_notes.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Contract Summary -->
                        <div class="card mb-3 bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">Contract Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Total Sessions:</strong> <span id="totalSessions">{{ form.number_of_sessions.data or 0 }}</span><br>
                                        <strong>Session Duration:</strong> <span id="sessionDuration">{{ form.session_duration.data or 0 }}</span> minutes<br>
                                        <strong>Price per Hour:</strong> $<span id="pricePerHour">{{ "%.2f"|format(form.price_per_hour.data or 0) }}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Total Hours:</strong> <span id="totalHours">0</span><br>
                                        <strong>Total Amount:</strong> $<span id="totalAmount" class="h5 text-success">0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Send Contract Offer
                            </button>
                            <a href="{{ url_for('job_management_enhanced', job_id=application.job_post_id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Job Management
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate total amount
function calculateTotal() {
    const sessions = parseInt(document.getElementById('{{ form.number_of_sessions.id }}').value) || 0;
    const duration = parseInt(document.getElementById('{{ form.session_duration.id }}').value) || 0;
    const pricePerHour = parseFloat(document.getElementById('{{ form.price_per_hour.id }}').value) || 0;
    
    const totalHours = (sessions * duration) / 60;
    const totalAmount = totalHours * pricePerHour;
    
    document.getElementById('totalSessions').textContent = sessions;
    document.getElementById('sessionDuration').textContent = duration;
    document.getElementById('pricePerHour').textContent = pricePerHour.toFixed(2);
    document.getElementById('totalHours').textContent = totalHours.toFixed(1);
    document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    const sessionsInput = document.getElementById('{{ form.number_of_sessions.id }}');
    const durationInput = document.getElementById('{{ form.session_duration.id }}');
    const priceInput = document.getElementById('{{ form.price_per_hour.id }}');
    
    sessionsInput.addEventListener('input', calculateTotal);
    durationInput.addEventListener('change', calculateTotal);
    priceInput.addEventListener('input', calculateTotal);
    
    // Initial calculation
    calculateTotal();
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
