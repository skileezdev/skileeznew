{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-primary-50 to-white py-12">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i data-feather="refresh-cw" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-3xl font-black text-gray-900 mb-2">Switch Your Role</h1>
            <p class="text-lg text-gray-600">
                You need {{ 'Coach' if user.get_other_role() == 'coach' else 'Student' }} access to view this page.
            </p>
        </div>

        <!-- Current Role Display -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 border border-gray-100">
            <div class="flex items-center justify-center mb-6">
                <div class="flex items-center space-x-4 px-6 py-3 bg-gray-100 rounded-xl">
                    <i data-feather="{{ 'briefcase' if user.current_role == 'coach' else 'book-open' }}" class="w-6 h-6 text-gray-600"></i>
                    <span class="text-lg font-semibold text-gray-800">Currently: {{ user.current_role.title() }}</span>
                </div>
            </div>

            <!-- Role Switch Form -->
            <div class="text-center" x-data="enhancedRoleSwitch()">
                <button @click="performSwitch()" 
                        :disabled="switching"
                        class="inline-flex items-center space-x-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-xl text-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 shadow-lg"
                        :class="switching ? 'opacity-50 cursor-not-allowed' : ''">
                    
                    <!-- Normal State -->
                    <div x-show="!switching" class="flex items-center space-x-3">
                        <i data-feather="refresh-cw" class="w-5 h-5"></i>
                        <span>Switch to {{ user.get_other_role().title() }}</span>
                        <i data-feather="arrow-right" class="w-5 h-5"></i>
                    </div>
                    
                    <!-- Switching State -->
                    <div x-show="switching" class="flex items-center space-x-3">
                        <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        <span>Switching...</span>
                    </div>
                </button>

                <!-- Progress Indicator -->
                <div x-show="switching" class="mt-6">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 h-2 rounded-full transition-all duration-1000" 
                             x-bind:style="`width: ${progress}%`"></div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="text-sm text-gray-600" x-text="progressMessage"></span>
                    </div>
                </div>
            </div>

            <!-- Alternative Actions -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="{{ url_for('coach_dashboard') if user.current_role == 'coach' else url_for('student_dashboard') }}" 
                       class="inline-flex items-center justify-center px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>
                        Back to {{ user.current_role.title() }} Dashboard
                    </a>

                    <a href="{{ url_for('index') }}" 
                       class="inline-flex items-center justify-center px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i data-feather="home" class="w-4 h-4 mr-2"></i>
                        Go to Home
                    </a>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="p-6 bg-blue-50 rounded-xl border border-blue-200">
            <div class="flex items-start">
                <i data-feather="info" class="w-6 h-6 text-blue-600 mr-3 mt-0.5"></i>
                <div>
                    <h4 class="text-lg font-semibold text-blue-900 mb-2">About Role Switching</h4>
                    <p class="text-blue-800 text-sm leading-relaxed">
                        You have both Student and Coach roles on Skileez. You can switch between these roles anytime to access different features. 
                        Your messages, profiles, and data are kept separate for each role to provide you with the best experience.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alpine.js for enhanced interactions -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<script>
function enhancedRoleSwitch() {
    return {
        switching: false,
        progress: 0,
        progressMessage: '',
        
        async performSwitch() {
            if (this.switching) return;
            
            this.switching = true;
            this.progress = 0;
            this.progressMessage = 'Preparing to switch...';
            
            // Animate progress
            const progressSteps = [
                { progress: 20, message: 'Validating permissions...' },
                { progress: 40, message: 'Switching role context...' },
                { progress: 60, message: 'Updating user session...' },
                { progress: 80, message: 'Loading new interface...' },
                { progress: 100, message: 'Almost done...' }
            ];
            
            for (let step of progressSteps) {
                await this.updateProgress(step.progress, step.message);
                await this.sleep(300);
            }
            
            try {
                const response = await fetch('/api/role-switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({
                        role: '{{ user.get_other_role() }}',
                        reason: 'manual_enhanced_switch'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.progressMessage = 'Switch successful! Redirecting...';
                    
                    // Show success message
                    this.showFlashMessage(data.message, 'success');
                    
                    // Redirect after short delay
                    setTimeout(() => {
                        window.location.href = data.dashboard_url;
                    }, 1500);
                    
                } else {
                    this.progressMessage = 'Switch failed';
                    this.showFlashMessage(data.error || 'Failed to switch roles', 'error');
                    this.switching = false;
                }
                
            } catch (error) {
                console.error('Role switch error:', error);
                this.progressMessage = 'Network error occurred';
                this.showFlashMessage('Network error. Please try again.', 'error');
                this.switching = false;
            }
        },
        
        async updateProgress(newProgress, message) {
            this.progress = newProgress;
            this.progressMessage = message;
        },
        
        sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },
        
        showFlashMessage(message, type) {
            // Create and show flash message
            const flashDiv = document.createElement('div');
            flashDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800'
            }`;
            
            flashDiv.innerHTML = `
                <div class="flex items-center">
                    <i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5 mr-2"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(flashDiv);
            
            // Replace feather icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                flashDiv.remove();
            }, 5000);
        },
        
        getCSRFToken() {
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) return csrfMeta.getAttribute('content');
            
            const csrfInput = document.querySelector('input[name="csrf_token"]');
            if (csrfInput) return csrfInput.value;
            
            return '';
        }
    }
}

// Initialize feather icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>
{% endblock %}