{% extends "base.html" %}

{% block title %}Notifications - Skileez{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-modern pt-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Notifications</h1>
                    <p class="text-gray-600">Stay updated with your latest activities</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="mark-all-read" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                        Mark All as Read
                    </button>
                </div>
            </div>
        </div>

        <!-- Notifications List -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            {% if notifications %}
                <div class="divide-y divide-gray-100">
                    {% for notification in notifications %}
                    <div class="notification-item p-6 hover:bg-gray-50 transition-colors {% if not notification.is_read %}bg-blue-50 border-l-4 border-blue-500{% endif %}" 
                         data-notification-id="{{ notification.id }}">
                        <div class="flex items-start space-x-4">
                            <!-- Notification Icon -->
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center 
                                            {% if notification.type == 'contract' %}bg-blue-100 text-blue-600
                                            {% elif notification.type == 'session' %}bg-green-100 text-green-600
                                            {% elif notification.type == 'message' %}bg-purple-100 text-purple-600
                                            {% else %}bg-gray-100 text-gray-600{% endif %}">
                                    {% if notification.type == 'contract' %}
                                        <i data-feather="file-text" class="w-5 h-5"></i>
                                    {% elif notification.type == 'session' %}
                                        <i data-feather="video" class="w-5 h-5"></i>
                                    {% elif notification.type == 'message' %}
                                        <i data-feather="message-circle" class="w-5 h-5"></i>
                                    {% else %}
                                        <i data-feather="bell" class="w-5 h-5"></i>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Notification Content -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-sm font-semibold text-gray-900 {% if not notification.is_read %}font-bold{% endif %}">
                                        {{ notification.title }}
                                    </h3>
                                    <div class="flex items-center space-x-2">
                                        {% if not notification.is_read %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                New
                                            </span>
                                        {% endif %}
                                        <span class="text-xs text-gray-500">
                                            {{ notification.created_at|relative_time if notification.created_at else 'Recently' }}
                                        </span>
                                    </div>
                                </div>
                                <p class="mt-1 text-sm text-gray-600">{{ notification.message }}</p>
                                
                                <!-- Action Buttons -->
                                <div class="mt-3 flex items-center space-x-3">
                                    {% if not notification.is_read %}
                                        <button class="mark-read-btn text-xs text-blue-600 hover:text-blue-800 font-medium">
                                            Mark as Read
                                        </button>
                                    {% endif %}
                                    {% if notification.related_id and notification.related_type %}
                                        <a href="#" class="text-xs text-primary-600 hover:text-primary-800 font-medium">
                                            View Details
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="p-12 text-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-feather="bell" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No notifications yet</h3>
                    <p class="text-gray-600">You'll see notifications here when you have new activity.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mark individual notification as read
    document.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const notificationItem = this.closest('.notification-item');
            const notificationId = notificationItem.dataset.notificationId;
            
            fetch(`/api/notifications/${notificationId}/mark-read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    notificationItem.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                    notificationItem.querySelector('.mark-read-btn').remove();
                    notificationItem.querySelector('.bg-blue-100').remove();
                    
                    // Update unread count in navigation
                    updateNotificationCount();
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // Mark all notifications as read
    document.getElementById('mark-all-read').addEventListener('click', function() {
        fetch('/api/notifications/mark-all-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove all unread styling
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                    const markReadBtn = item.querySelector('.mark-read-btn');
                    if (markReadBtn) markReadBtn.remove();
                    const newBadge = item.querySelector('.bg-blue-100');
                    if (newBadge) newBadge.remove();
                });
                
                // Update unread count in navigation
                updateNotificationCount();
            }
        })
        .catch(error => console.error('Error:', error));
    });

    function updateNotificationCount() {
        fetch('/api/notifications/unread-count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }
});
</script>
{% endblock %}
