{% macro render_call_card(call, user) %}
{% if call %}
<div class="call-card bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm">
    <div class="flex items-start justify-between">
        <!-- Call Info -->
        <div class="flex-1">
            <div class="flex items-center mb-2">
                {% if call.is_free_consultation %}
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <i data-feather="phone" class="w-4 h-4 text-green-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-900">Free Consultation Call</h4>
                {% else %}
                    <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                        <i data-feather="video" class="w-4 h-4 text-primary-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-900">Learning Session</h4>
                {% endif %}
            </div>
            
            <!-- Call Details -->
            <div class="space-y-1 text-sm text-gray-600 mb-3">
                <div class="flex items-center">
                    <i data-feather="calendar" class="w-4 h-4 mr-2"></i>
                    <span>{{ call.scheduled_at|format_datetime('full') if call.scheduled_at else 'TBD' }}</span>
                </div>
                <div class="flex items-center">
                    <i data-feather="clock" class="w-4 h-4 mr-2"></i>
                    <span>{{ call.duration_minutes if call.duration_minutes else 15 }} minutes</span>
                </div>
                {% if call.is_paid_session and call.contract %}
                    <div class="flex items-center">
                        <i data-feather="dollar-sign" class="w-4 h-4 mr-2"></i>
                        <span>${{ "%.2f"|format(call.contract.rate) }} (Paid)</span>
                    </div>
                {% else %}
                    <div class="flex items-center">
                        <i data-feather="dollar-sign" class="w-4 h-4 mr-2"></i>
                        <span>Free</span>
                    </div>
                {% endif %}
            </div>
            
            <!-- Status Badge -->
            <div class="mb-3">
                {% if call.status == 'scheduled' %}
                    {% if call.is_ready_to_join %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i data-feather="circle" class="w-2 h-2 mr-1 fill-current"></i>
                            Ready to Join
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i data-feather="clock" class="w-2 h-2 mr-1"></i>
                            Scheduled
                        </span>
                    {% endif %}
                {% elif call.status == 'active' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                        <i data-feather="play" class="w-2 h-2 mr-1"></i>
                        In Progress
                    </span>
                {% elif call.status == 'completed' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        <i data-feather="check" class="w-2 h-2 mr-1"></i>
                        Completed
                    </span>
                {% elif call.status == 'cancelled' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        <i data-feather="x" class="w-2 h-2 mr-1"></i>
                        Cancelled
                    </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex flex-col space-y-2 ml-4">
            {% if call.status == 'scheduled' %}
                {% if call.is_ready_to_join %}
                    <a href="{{ url_for('join_call', call_id=call.id) }}" 
                       class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                        <i data-feather="play" class="w-4 h-4 mr-2"></i>
                        Join Call
                    </a>
                {% else %}
                    <div class="text-xs text-gray-500 text-center">
                        <div>Starts in</div>
                        <div class="font-medium">{{ call.time_until_call if call.time_until_call else 'TBD' }}</div>
                    </div>
                {% endif %}
                
                <!-- Cancel/Reschedule buttons -->
                <div class="flex space-x-2">
                    {% if call.can_be_rescheduled and call.can_be_rescheduled('student') %}
                        <a href="{{ url_for('reschedule_call', call_id=call.id) }}" 
                           class="inline-flex items-center px-3 py-1.5 bg-gray-100 text-gray-700 text-xs font-medium rounded hover:bg-gray-200 transition-colors">
                            <i data-feather="refresh-cw" class="w-3 h-3 mr-1"></i>
                            Reschedule
                        </a>
                    {% endif %}
                    
                    <!-- Setup Meeting button for coaches -->
                    {% if user.is_coach and user.id == call.coach_id %}
                        <a href="{{ url_for('call_meeting_setup', call_id=call.id) }}" 
                           class="inline-flex items-center px-3 py-1.5 bg-blue-100 text-blue-700 text-xs font-medium rounded hover:bg-blue-200 transition-colors">
                            <i data-feather="settings" class="w-3 h-3 mr-1"></i>
                            Setup Meeting
                        </a>
                    {% endif %}
                    
                    <button onclick="showCancelModal({{ call.id }})" 
                            class="inline-flex items-center px-3 py-1.5 bg-red-100 text-red-700 text-xs font-medium rounded hover:bg-red-200 transition-colors">
                        <i data-feather="x" class="w-3 h-3 mr-1"></i>
                        Cancel
                    </button>
                </div>
            {% elif call.status == 'active' %}
                <a href="{{ url_for('join_call', call_id=call.id) }}" 
                   class="inline-flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 transition-colors">
                    <i data-feather="play" class="w-4 h-4 mr-2"></i>
                    Rejoin Call
                </a>
            {% elif call.status == 'completed' %}
                <a href="{{ url_for('view_call', call_id=call.id) }}" 
                   class="inline-flex items-center px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition-colors">
                    <i data-feather="eye" class="w-4 h-4 mr-2"></i>
                    View Details
                </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Notes (if any) -->
    {% if call.notes %}
        <div class="mt-3 pt-3 border-t border-gray-100">
            <div class="text-sm text-gray-600">
                <strong>Notes:</strong> {{ call.notes }}
            </div>
        </div>
    {% endif %}
    
    <!-- Countdown Timer (for scheduled calls) -->
    {% if call.status == 'scheduled' and not call.is_ready_to_join %}
        <div class="mt-3 pt-3 border-t border-gray-100">
            <div class="text-xs text-gray-500">
                <i data-feather="clock" class="w-3 h-3 inline mr-1"></i>
                Call starts in <span class="font-medium">{{ call.time_until_call if call.time_until_call else 'TBD' }}</span>
            </div>
        </div>
    {% endif %}
</div>

<!-- Cancel Call Modal -->
<div id="cancel-modal-{{ call.id }}" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" style="display: none;">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Cancel Call</h3>
            <p class="text-gray-600 mb-4">Are you sure you want to cancel this call? This action cannot be undone.</p>
            
            <form method="POST" action="{{ url_for('cancel_call', call_id=call.id) }}" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for cancellation (optional)</label>
                    <textarea name="reason" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Please provide a reason for cancelling..."></textarea>
                </div>
                
                <div class="flex space-x-3">
                    <button type="button" onclick="hideCancelModal({{ call.id }})" 
                            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                        Keep Call
                    </button>
                    <button type="submit" 
                            class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        Cancel Call
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Use a more specific function name to avoid conflicts
function showCancelModal(callId) {
    const modal = document.getElementById(`cancel-modal-${callId}`);
    if (modal) {
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
    }
}

function hideCancelModal(callId) {
    const modal = document.getElementById(`cancel-modal-${callId}`);
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('fixed') && event.target.classList.contains('bg-black')) {
        event.target.classList.add('hidden');
        event.target.style.display = 'none';
    }
});

// Only auto-refresh if the call is ready to join (less disruptive)
{% if call.status == 'scheduled' and call.is_ready_to_join %}
setTimeout(function() {
    // Only refresh if the call should be ready
    location.reload();
}, 30000); // 30 seconds instead of 60
{% endif %}
</script>
{% else %}
<!-- Fallback if call object is not available -->
<div class="call-card bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm">
    <div class="flex items-center">
        <i data-feather="phone" class="w-4 h-4 mr-2 text-green-600"></i>
        <span class="text-gray-600">Call information unavailable</span>
    </div>
</div>
{% endif %}
{% endmacro %}
