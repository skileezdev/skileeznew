{% extends "base.html" %}

{% block title %}{{ coach.first_name }} {{ coach.last_name }} - Availability{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-primary-500 to-purple-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl font-bold">
                            {{ coach.first_name[0] }}{{ coach.last_name[0] }}
                        </span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">
                            {{ coach.first_name }} {{ coach.last_name }}
                        </h1>
                        <p class="text-gray-600">
                            {% if availability.is_available %}
                                <span class="text-green-600">● Available for bookings</span>
                            {% else %}
                                <span class="text-red-600">● Not accepting bookings</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">Timezone: {{ availability.timezone }}</p>
                    <p class="text-sm text-gray-500">Default session: {{ availability.session_duration }} minutes</p>
                </div>
            </div>
        </div>

        <!-- Availability Calendar -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Available Times</h2>
                <div class="flex space-x-2">
                    <button id="prev-week" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Previous Week
                    </button>
                    <button id="next-week" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Next Week
                    </button>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="grid grid-cols-8 gap-4">
                <!-- Time slots column -->
                <div class="space-y-2">
                    <div class="h-12"></div> <!-- Header spacer -->
                    {% for hour in range(6, 22) %}
                        <div class="h-16 text-xs text-gray-500 text-right pr-2 pt-2">
                            {{ hour }}:00
                        </div>
                    {% endfor %}
                </div>

                <!-- Days of the week -->
                {% for day in range(7) %}
                    <div class="text-center">
                        <div class="h-12 flex items-center justify-center">
                            <div>
                                <div class="text-sm font-medium text-gray-900" id="day-name-{{ day }}">
                                    {{ ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][day] }}
                                </div>
                                <div class="text-xs text-gray-500" id="day-date-{{ day }}">
                                    {{ (today + timedelta(days=day)).strftime('%b %d') }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Time slots for this day -->
                        <div class="space-y-1" id="day-slots-{{ day }}">
                            {% for hour in range(6, 22) %}
                                <div class="h-16 border border-gray-200 rounded-md bg-gray-50" 
                                     data-day="{{ day }}" 
                                     data-hour="{{ hour }}"
                                     data-available="false">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Booking Section -->
        {% if availability.is_available %}
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Book a Session</h3>
            
            <!-- Session Type Selection -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Free Consultation -->
                {% if availability.consultation_available %}
                <div class="border border-gray-200 rounded-lg p-4 hover:border-primary-300 cursor-pointer" 
                     onclick="selectSessionType('consultation')" 
                     id="consultation-card">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-900">Free Consultation</h4>
                        <span class="text-green-600 text-sm font-medium">FREE</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">
                        {{ availability.consultation_duration }} minutes to discuss your learning goals
                    </p>
                    <p class="text-xs text-gray-500">
                        Must be booked {{ availability.consultation_advance_hours }} hours in advance
                    </p>
                </div>
                {% endif %}

                <!-- Paid Session -->
                <div class="border border-gray-200 rounded-lg p-4 hover:border-primary-300 cursor-pointer" 
                     onclick="selectSessionType('paid')" 
                     id="paid-card">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-900">Paid Session</h4>
                        <span class="text-primary-600 text-sm font-medium">PAID</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">
                        Full coaching session (requires active contract)
                    </p>
                    <p class="text-xs text-gray-500">
                        {{ availability.session_duration }} minutes default duration
                    </p>
                </div>
            </div>

            <!-- Booking Form -->
            <form id="booking-form" class="space-y-4" style="display: none;">
                <input type="hidden" id="session-type" name="session_type">
                <input type="hidden" id="selected-time" name="selected_time">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Selected Time
                        </label>
                        <div id="selected-time-display" class="text-sm text-gray-900 bg-gray-50 p-3 rounded-md">
                            No time selected
                        </div>
                    </div>
                    
                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">
                            Duration (minutes)
                        </label>
                        <input type="number" 
                               id="duration" 
                               name="duration_minutes" 
                               min="15" 
                               max="480" 
                               value="{{ availability.session_duration }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                </div>

                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
                        Notes (Optional)
                    </label>
                    <textarea id="notes" 
                              name="notes" 
                              rows="3"
                              placeholder="Any specific topics or questions you'd like to discuss..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500"></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" 
                            onclick="resetBooking()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        Book Session
                    </button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
let currentWeek = 0;
let selectedSessionType = null;
let selectedTime = null;
let availableSlots = {{ available_slots | tojson }};

// Initialize calendar
document.addEventListener('DOMContentLoaded', function() {
    loadAvailability();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('prev-week').addEventListener('click', () => {
        currentWeek--;
        loadAvailability();
    });
    
    document.getElementById('next-week').addEventListener('click', () => {
        currentWeek++;
        loadAvailability();
    });
    
    document.getElementById('booking-form').addEventListener('submit', handleBooking);
}

function loadAvailability() {
    // Update date headers
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() + (currentWeek * 7));
    
    for (let day = 0; day < 7; day++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + day);
        
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        document.getElementById(`day-name-${day}`).textContent = dayNames[day];
        document.getElementById(`day-date-${day}`).textContent = date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
        });
        
        // Load slots for this day
        loadDaySlots(day, date);
    }
}

function loadDaySlots(day, date) {
    const dateStr = date.toISOString().split('T')[0];
    const slots = availableSlots[dateStr] || [];
    
    // Clear existing slots
    const dayContainer = document.getElementById(`day-slots-${day}`);
    dayContainer.innerHTML = '';
    
    // Create time slots
    for (let hour = 6; hour < 22; hour++) {
        const slot = document.createElement('div');
        slot.className = 'h-16 border border-gray-200 rounded-md cursor-pointer transition-colors';
        slot.dataset.day = day;
        slot.dataset.hour = hour;
        slot.dataset.date = dateStr;
        
        // Check if slot is available
        const isAvailable = slots.some(s => {
            const slotHour = new Date(s.start).getHours();
            return slotHour === hour;
        });
        
        if (isAvailable) {
            slot.classList.add('bg-green-50', 'border-green-300', 'hover:bg-green-100');
            slot.dataset.available = 'true';
            slot.addEventListener('click', () => selectTimeSlot(day, hour, dateStr));
        } else {
            slot.classList.add('bg-gray-50');
            slot.dataset.available = 'false';
        }
        
        dayContainer.appendChild(slot);
    }
}

function selectSessionType(type) {
    selectedSessionType = type;
    
    // Update UI
    document.getElementById('consultation-card').classList.remove('border-primary-300', 'bg-primary-50');
    document.getElementById('paid-card').classList.remove('border-primary-300', 'bg-primary-50');
    
    document.getElementById(`${type}-card`).classList.add('border-primary-300', 'bg-primary-50');
    
    // Show booking form
    document.getElementById('booking-form').style.display = 'block';
    document.getElementById('session-type').value = type;
}

function selectTimeSlot(day, hour, dateStr) {
    if (!selectedSessionType) {
        alert('Please select a session type first');
        return;
    }
    
    selectedTime = {
        day: day,
        hour: hour,
        date: dateStr,
        datetime: `${dateStr}T${hour.toString().padStart(2, '0')}:00`
    };
    
    // Update display
    const timeDisplay = document.getElementById('selected-time-display');
    const date = new Date(selectedTime.datetime);
    timeDisplay.textContent = date.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
    });
    
    document.getElementById('selected-time').value = selectedTime.datetime;
    
    // Update slot styling
    document.querySelectorAll('[data-available="true"]').forEach(slot => {
        slot.classList.remove('ring-2', 'ring-primary-500');
    });
    
    const selectedSlot = document.querySelector(`[data-day="${day}"][data-hour="${hour}"]`);
    if (selectedSlot) {
        selectedSlot.classList.add('ring-2', 'ring-primary-500');
    }
}

function resetBooking() {
    selectedSessionType = null;
    selectedTime = null;
    
    document.getElementById('booking-form').style.display = 'none';
    document.getElementById('consultation-card').classList.remove('border-primary-300', 'bg-primary-50');
    document.getElementById('paid-card').classList.remove('border-primary-300', 'bg-primary-50');
    
    document.querySelectorAll('[data-available="true"]').forEach(slot => {
        slot.classList.remove('ring-2', 'ring-primary-500');
    });
}

async function handleBooking(event) {
    event.preventDefault();
    
    if (!selectedTime) {
        alert('Please select a time slot');
        return;
    }
    
    const formData = new FormData(event.target);
    const bookingData = {
        coach_id: {{ coach.id }},
        scheduled_at: selectedTime.datetime,
        duration_minutes: parseInt(formData.get('duration_minutes')),
        session_type: formData.get('session_type'),
        notes: formData.get('notes')
    };
    
    try {
        const response = await fetch('/api/scheduling/book', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bookingData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = `/scheduling/session/${result.session_id}`;
        } else {
            alert(result.error || 'Booking failed');
        }
    } catch (error) {
        console.error('Booking error:', error);
        alert('An error occurred while booking the session');
    }
}
</script>
{% endblock %}
